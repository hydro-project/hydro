---
source: hydro_test/src/cluster/two_pc_bench.rs
expression: "preview.dfir_for(&coordinator).to_mermaid(&WriteConfig\n{\n    no_subgraphs: true, no_pull_push: true, no_handoffs: true,\n    op_text_no_imports: true, ..WriteConfig::default()\n})"
---
%%{init:{'theme':'base','themeVariables':{'clusterBkg':'#ddd','clusterBorder':'#888'}}}%%
flowchart TD
classDef pullClass fill:#8af,stroke:#000,text-align:left,white-space:pre
classDef pushClass fill:#ff8,stroke:#000,text-align:left,white-space:pre
classDef otherClass fill:#fdc,stroke:#000,text-align:left,white-space:pre
linkStyle default stroke:#aaa
1v1["<div style=text-align:center>(1v1)</div> <code><br>defer_tick_lazy()</code>"]:::otherClass
2v1["<div style=text-align:center>(2v1)</div> <code><br>source_stream({<br>    let cluster_ids__free = __hydro_lang_cluster_ids_1;<br>    Box::new(<br>        futures::stream::iter(<br>            cluster_ids__free<br>                .iter()<br>                .cloned()<br>                .map(|member_id| (member_id, MembershipEvent::Joined)),<br>        ),<br>    ) as Box&lt;dyn futures::Stream&lt;Item = (TaglessMemberId, MembershipEvent)&gt; + Unpin&gt;<br>})</code>"]:::otherClass
3v1["<div style=text-align:center>(3v1)</div> <code><br>map({<br>    |(k, v)| (MemberId::from_tagless(k), v)<br>})</code>"]:::otherClass
4v1["<div style=text-align:center>(4v1)</div> <code><br>fold_keyed::&lt;<br>    'static,<br>&gt;(<br>    {<br>        || false<br>    },<br>    {<br>        |present, event| {<br>            match event {<br>                MembershipEvent::Joined =&gt; *present = true,<br>                MembershipEvent::Left =&gt; *present = false,<br>            }<br>        }<br>    },<br>)</code>"]:::otherClass
5v1["<div style=text-align:center>(5v1)</div> <code><br>filter({<br>    let f__free = {<br>        |b| *b<br>    };<br>    {<br>        let orig = f__free;<br>        move |t: &amp;(_, _)| orig(&amp;t.1)<br>    }<br>})</code>"]:::otherClass
6v1["<div style=text-align:center>(6v1)</div> <code><br>map({<br>    |(k, _)| k<br>})</code>"]:::otherClass
7v1["<div style=text-align:center>(7v1)</div> <code><br>source_stream(DUMMY_SOURCE)</code>"]:::otherClass
8v1["<div style=text-align:center>(8v1)</div> <code><br>map(|res| {<br>    let (id, b) = res.unwrap();<br>    (<br>        hydro_lang::__staged::location::MemberId::&lt;<br>            hydro_test::__staged::cluster::two_pc_bench::Client,<br>        &gt;::from_tagless(id as hydro_lang::__staged::location::TaglessMemberId),<br>        hydro_lang::runtime_support::bincode::deserialize::&lt;(u32, u32)&gt;(&amp;b).unwrap(),<br>    )<br>})</code>"]:::otherClass
9v1["<div style=text-align:center>(9v1)</div> <code><br>cross_join_multiset::&lt;'tick, 'tick&gt;()</code>"]:::otherClass
10v1["<div style=text-align:center>(10v1)</div> <code><br>map(|(id, data)| {<br>    (<br>        id.into_tagless(),<br>        hydro_lang::runtime_support::bincode::serialize(&amp;data).unwrap().into(),<br>    )<br>})</code>"]:::otherClass
11v1["<div style=text-align:center>(11v1)</div> <code><br>dest_sink(DUMMY_SINK)</code>"]:::otherClass
12v1["<div style=text-align:center>(12v1)</div> <code><br>source_stream(DUMMY_SOURCE)</code>"]:::otherClass
13v1["<div style=text-align:center>(13v1)</div> <code><br>map(|res| {<br>    let (id, b) = res.unwrap();<br>    (<br>        hydro_lang::__staged::location::MemberId::&lt;<br>            hydro_test::__staged::cluster::two_pc::Participant,<br>        &gt;::from_tagless(id as hydro_lang::__staged::location::TaglessMemberId),<br>        hydro_lang::runtime_support::bincode::deserialize::&lt;<br>            (<br>                hydro_test::__staged::__deps::hydro_lang::location::member_id::MemberId&lt;<br>                    hydro_test::__staged::cluster::two_pc_bench::Client,<br>                &gt;,<br>                (u32, u32),<br>            ),<br>        &gt;(&amp;b)<br>            .unwrap(),<br>    )<br>})</code>"]:::otherClass
14v1["<div style=text-align:center>(14v1)</div> <code><br>map({<br>    |(_, v)| v<br>})</code>"]:::otherClass
15v1["<div style=text-align:center>(15v1)</div> <code><br>map({<br>    |kv| (kv, Ok::&lt;(), ()&gt;(()))<br>})</code>"]:::otherClass
17v1["<div style=text-align:center>(17v1)</div> <code><br>chain()</code>"]:::otherClass
18v1["<div style=text-align:center>(18v1)</div> <code><br>tee()</code>"]:::otherClass
19v1["<div style=text-align:center>(19v1)</div> <code><br>fold_keyed::&lt;<br>    'tick,<br>&gt;(<br>    {<br>        move || (0, 0)<br>    },<br>    {<br>        move |accum, value| {<br>            if value.is_ok() {<br>                accum.0 += 1;<br>            } else {<br>                accum.1 += 1;<br>            }<br>        }<br>    },<br>)</code>"]:::otherClass
21v1["<div style=text-align:center>(21v1)</div> <code><br>filter_map({<br>    let min__free = 3usize;<br>    move |(key, (success, _error))| {<br>        if success &gt;= min__free { Some(key) } else { None }<br>    }<br>})</code>"]:::otherClass
22v1["<div style=text-align:center>(22v1)</div> <code><br>tee()</code>"]:::otherClass
23v1["<div style=text-align:center>(23v1)</div> <code><br>anti_join::&lt;'tick, 'tick&gt;()</code>"]:::otherClass
24v1["<div style=text-align:center>(24v1)</div> <code><br>identity::&lt;<br>    (<br>        (<br>            hydro_test::__staged::__deps::hydro_lang::location::member_id::MemberId&lt;<br>                hydro_test::__staged::cluster::two_pc_bench::Client,<br>            &gt;,<br>            (u32, u32),<br>        ),<br>        core::result::Result&lt;(), ()&gt;,<br>    ),<br>&gt;()</code>"]:::otherClass
25v1["<div style=text-align:center>(25v1)</div> <code><br>defer_tick_lazy()</code>"]:::otherClass
26v1["<div style=text-align:center>(26v1)</div> <code><br>identity::&lt;<br>    (<br>        hydro_test::__staged::__deps::hydro_lang::location::member_id::MemberId&lt;<br>            hydro_test::__staged::cluster::two_pc_bench::Client,<br>        &gt;,<br>        (u32, u32),<br>    ),<br>&gt;()</code>"]:::otherClass
27v1["<div style=text-align:center>(27v1)</div> <code><br>defer_tick_lazy()</code>"]:::otherClass
28v1["<div style=text-align:center>(28v1)</div> <code><br>source_stream({<br>    let cluster_ids__free = __hydro_lang_cluster_ids_1;<br>    Box::new(<br>        futures::stream::iter(<br>            cluster_ids__free<br>                .iter()<br>                .cloned()<br>                .map(|member_id| (member_id, MembershipEvent::Joined)),<br>        ),<br>    ) as Box&lt;dyn futures::Stream&lt;Item = (TaglessMemberId, MembershipEvent)&gt; + Unpin&gt;<br>})</code>"]:::otherClass
29v1["<div style=text-align:center>(29v1)</div> <code><br>map({<br>    |(k, v)| (MemberId::from_tagless(k), v)<br>})</code>"]:::otherClass
30v1["<div style=text-align:center>(30v1)</div> <code><br>fold_keyed::&lt;<br>    'static,<br>&gt;(<br>    {<br>        || false<br>    },<br>    {<br>        |present, event| {<br>            match event {<br>                MembershipEvent::Joined =&gt; *present = true,<br>                MembershipEvent::Left =&gt; *present = false,<br>            }<br>        }<br>    },<br>)</code>"]:::otherClass
31v1["<div style=text-align:center>(31v1)</div> <code><br>filter({<br>    let f__free = {<br>        |b| *b<br>    };<br>    {<br>        let orig = f__free;<br>        move |t: &amp;(_, _)| orig(&amp;t.1)<br>    }<br>})</code>"]:::otherClass
32v1["<div style=text-align:center>(32v1)</div> <code><br>map({<br>    |(k, _)| k<br>})</code>"]:::otherClass
33v1["<div style=text-align:center>(33v1)</div> <code><br>cross_join_multiset::&lt;'tick, 'tick&gt;()</code>"]:::otherClass
34v1["<div style=text-align:center>(34v1)</div> <code><br>map(|(id, data)| {<br>    (<br>        id.into_tagless(),<br>        hydro_lang::runtime_support::bincode::serialize(&amp;data).unwrap().into(),<br>    )<br>})</code>"]:::otherClass
35v1["<div style=text-align:center>(35v1)</div> <code><br>dest_sink(DUMMY_SINK)</code>"]:::otherClass
36v1["<div style=text-align:center>(36v1)</div> <code><br>source_stream(DUMMY_SOURCE)</code>"]:::otherClass
37v1["<div style=text-align:center>(37v1)</div> <code><br>map(|res| {<br>    let (id, b) = res.unwrap();<br>    (<br>        hydro_lang::__staged::location::MemberId::&lt;<br>            hydro_test::__staged::cluster::two_pc::Participant,<br>        &gt;::from_tagless(id as hydro_lang::__staged::location::TaglessMemberId),<br>        hydro_lang::runtime_support::bincode::deserialize::&lt;<br>            (<br>                hydro_test::__staged::__deps::hydro_lang::location::member_id::MemberId&lt;<br>                    hydro_test::__staged::cluster::two_pc_bench::Client,<br>                &gt;,<br>                (u32, u32),<br>            ),<br>        &gt;(&amp;b)<br>            .unwrap(),<br>    )<br>})</code>"]:::otherClass
38v1["<div style=text-align:center>(38v1)</div> <code><br>map({<br>    |(_, v)| v<br>})</code>"]:::otherClass
39v1["<div style=text-align:center>(39v1)</div> <code><br>map({<br>    |kv| (kv, Ok::&lt;(), ()&gt;(()))<br>})</code>"]:::otherClass
41v1["<div style=text-align:center>(41v1)</div> <code><br>chain()</code>"]:::otherClass
42v1["<div style=text-align:center>(42v1)</div> <code><br>tee()</code>"]:::otherClass
43v1["<div style=text-align:center>(43v1)</div> <code><br>fold_keyed::&lt;<br>    'tick,<br>&gt;(<br>    {<br>        move || (0, 0)<br>    },<br>    {<br>        move |accum, value| {<br>            if value.is_ok() {<br>                accum.0 += 1;<br>            } else {<br>                accum.1 += 1;<br>            }<br>        }<br>    },<br>)</code>"]:::otherClass
45v1["<div style=text-align:center>(45v1)</div> <code><br>filter_map({<br>    let min__free = 3usize;<br>    move |(key, (success, _error))| {<br>        if success &gt;= min__free { Some(key) } else { None }<br>    }<br>})</code>"]:::otherClass
46v1["<div style=text-align:center>(46v1)</div> <code><br>tee()</code>"]:::otherClass
47v1["<div style=text-align:center>(47v1)</div> <code><br>anti_join::&lt;'tick, 'tick&gt;()</code>"]:::otherClass
48v1["<div style=text-align:center>(48v1)</div> <code><br>identity::&lt;<br>    (<br>        (<br>            hydro_test::__staged::__deps::hydro_lang::location::member_id::MemberId&lt;<br>                hydro_test::__staged::cluster::two_pc_bench::Client,<br>            &gt;,<br>            (u32, u32),<br>        ),<br>        core::result::Result&lt;(), ()&gt;,<br>    ),<br>&gt;()</code>"]:::otherClass
49v1["<div style=text-align:center>(49v1)</div> <code><br>defer_tick_lazy()</code>"]:::otherClass
50v1["<div style=text-align:center>(50v1)</div> <code><br>identity::&lt;<br>    (<br>        hydro_test::__staged::__deps::hydro_lang::location::member_id::MemberId&lt;<br>            hydro_test::__staged::cluster::two_pc_bench::Client,<br>        &gt;,<br>        (u32, u32),<br>    ),<br>&gt;()</code>"]:::otherClass
51v1["<div style=text-align:center>(51v1)</div> <code><br>map(|(id, data)| {<br>    (<br>        id.into_tagless(),<br>        hydro_lang::runtime_support::bincode::serialize(&amp;data).unwrap().into(),<br>    )<br>})</code>"]:::otherClass
52v1["<div style=text-align:center>(52v1)</div> <code><br>dest_sink(DUMMY_SINK)</code>"]:::otherClass
66v1["<div style=text-align:center>(66v1)</div> <code><br>identity()</code>"]:::otherClass
68v1["<div style=text-align:center>(68v1)</div> <code><br>identity()</code>"]:::otherClass
70v1["<div style=text-align:center>(70v1)</div> <code><br>identity()</code>"]:::otherClass
72v1["<div style=text-align:center>(72v1)</div> <code><br>identity()</code>"]:::otherClass
24v1-->66v1
2v1-->3v1
3v1--x4v1; linkStyle 2 stroke:red
4v1-->5v1
5v1-->6v1
7v1-->8v1
6v1-->|0|9v1
8v1-->|1|9v1
10v1-->11v1
9v1-->10v1
12v1-->13v1
13v1-->14v1
14v1-->15v1
1v1--x|0|17v1; linkStyle 13 stroke:red
15v1-->|1|17v1
17v1-->18v1
18v1--x19v1; linkStyle 16 stroke:red
19v1-->21v1
21v1-->22v1
18v1-->|pos|23v1
22v1--x|neg|23v1; linkStyle 20 stroke:red
23v1-->24v1
26v1-->68v1
25v1-->26v1
48v1-->70v1
28v1-->29v1
29v1--x30v1; linkStyle 26 stroke:red
30v1-->31v1
31v1-->32v1
32v1-->|0|33v1
22v1-->|1|33v1
34v1-->35v1
33v1-->34v1
36v1-->37v1
37v1-->38v1
38v1-->39v1
27v1--x|0|41v1; linkStyle 36 stroke:red
39v1-->|1|41v1
41v1-->42v1
42v1--x43v1; linkStyle 39 stroke:red
43v1-->45v1
45v1-->46v1
42v1-->|pos|47v1
46v1--x|neg|47v1; linkStyle 43 stroke:red
47v1-->48v1
50v1-->72v1
49v1-->50v1
51v1-->52v1
46v1-->51v1
66v1--o1v1; linkStyle 49 stroke:red
68v1--o25v1; linkStyle 50 stroke:red
70v1--o27v1; linkStyle 51 stroke:red
72v1--o49v1; linkStyle 52 stroke:red
10v1
11v1
34v1
35v1
51v1
52v1
66v1
68v1
70v1
72v1
subgraph var_cycle_1 ["var <tt>cycle_1</tt>"]
    style var_cycle_1 fill:transparent
    24v1
end
subgraph var_cycle_2 ["var <tt>cycle_2</tt>"]
    style var_cycle_2 fill:transparent
    26v1
end
subgraph var_cycle_3 ["var <tt>cycle_3</tt>"]
    style var_cycle_3 fill:transparent
    48v1
end
subgraph var_cycle_4 ["var <tt>cycle_4</tt>"]
    style var_cycle_4 fill:transparent
    50v1
end
subgraph var_stream_1 ["var <tt>stream_1</tt>"]
    style var_stream_1 fill:transparent
    1v1
end
subgraph var_stream_10 ["var <tt>stream_10</tt>"]
    style var_stream_10 fill:transparent
    6v1
end
subgraph var_stream_13 ["var <tt>stream_13</tt>"]
    style var_stream_13 fill:transparent
    8v1
    7v1
end
subgraph var_stream_17 ["var <tt>stream_17</tt>"]
    style var_stream_17 fill:transparent
    9v1
end
subgraph var_stream_2 ["var <tt>stream_2</tt>"]
    style var_stream_2 fill:transparent
    2v1
end
subgraph var_stream_21 ["var <tt>stream_21</tt>"]
    style var_stream_21 fill:transparent
    13v1
    12v1
end
subgraph var_stream_24 ["var <tt>stream_24</tt>"]
    style var_stream_24 fill:transparent
    14v1
end
subgraph var_stream_25 ["var <tt>stream_25</tt>"]
    style var_stream_25 fill:transparent
    15v1
end
subgraph var_stream_28 ["var <tt>stream_28</tt>"]
    style var_stream_28 fill:transparent
    17v1
end
subgraph var_stream_29 ["var <tt>stream_29</tt>"]
    style var_stream_29 fill:transparent
    18v1
end
subgraph var_stream_3 ["var <tt>stream_3</tt>"]
    style var_stream_3 fill:transparent
    3v1
end
subgraph var_stream_33 ["var <tt>stream_33</tt>"]
    style var_stream_33 fill:transparent
    19v1
end
subgraph var_stream_37 ["var <tt>stream_37</tt>"]
    style var_stream_37 fill:transparent
    21v1
end
subgraph var_stream_38 ["var <tt>stream_38</tt>"]
    style var_stream_38 fill:transparent
    22v1
end
subgraph var_stream_39 ["var <tt>stream_39</tt>"]
    style var_stream_39 fill:transparent
    23v1
end
subgraph var_stream_41 ["var <tt>stream_41</tt>"]
    style var_stream_41 fill:transparent
    25v1
end
subgraph var_stream_43 ["var <tt>stream_43</tt>"]
    style var_stream_43 fill:transparent
    27v1
end
subgraph var_stream_44 ["var <tt>stream_44</tt>"]
    style var_stream_44 fill:transparent
    28v1
end
subgraph var_stream_45 ["var <tt>stream_45</tt>"]
    style var_stream_45 fill:transparent
    29v1
end
subgraph var_stream_47 ["var <tt>stream_47</tt>"]
    style var_stream_47 fill:transparent
    30v1
end
subgraph var_stream_49 ["var <tt>stream_49</tt>"]
    style var_stream_49 fill:transparent
    31v1
end
subgraph var_stream_5 ["var <tt>stream_5</tt>"]
    style var_stream_5 fill:transparent
    4v1
end
subgraph var_stream_52 ["var <tt>stream_52</tt>"]
    style var_stream_52 fill:transparent
    32v1
end
subgraph var_stream_57 ["var <tt>stream_57</tt>"]
    style var_stream_57 fill:transparent
    33v1
end
subgraph var_stream_61 ["var <tt>stream_61</tt>"]
    style var_stream_61 fill:transparent
    37v1
    36v1
end
subgraph var_stream_64 ["var <tt>stream_64</tt>"]
    style var_stream_64 fill:transparent
    38v1
end
subgraph var_stream_65 ["var <tt>stream_65</tt>"]
    style var_stream_65 fill:transparent
    39v1
end
subgraph var_stream_68 ["var <tt>stream_68</tt>"]
    style var_stream_68 fill:transparent
    41v1
end
subgraph var_stream_69 ["var <tt>stream_69</tt>"]
    style var_stream_69 fill:transparent
    42v1
end
subgraph var_stream_7 ["var <tt>stream_7</tt>"]
    style var_stream_7 fill:transparent
    5v1
end
subgraph var_stream_73 ["var <tt>stream_73</tt>"]
    style var_stream_73 fill:transparent
    43v1
end
subgraph var_stream_77 ["var <tt>stream_77</tt>"]
    style var_stream_77 fill:transparent
    45v1
end
subgraph var_stream_78 ["var <tt>stream_78</tt>"]
    style var_stream_78 fill:transparent
    46v1
end
subgraph var_stream_79 ["var <tt>stream_79</tt>"]
    style var_stream_79 fill:transparent
    47v1
end
subgraph var_stream_81 ["var <tt>stream_81</tt>"]
    style var_stream_81 fill:transparent
    49v1
end
