name: CI

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
  schedule:
    - cron: "35 03 * * *" # Daily at 8:35 PM PDT, 7:35 PM PST.
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_STRIP: "debuginfo"
  CARGO_PROFILE_TEST_STRIP: "debuginfo"
  CARGO_PROFILE_RELEASE_STRIP: "debuginfo"

defaults:
  run:
    shell: bash # default shell on windows is pwsh

jobs:
  pre_job:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5.3.1
        with:
          cancel_others: "true"

  test:
    name: All tests, lints, and checks
    if: ${{ needs.pre_job.outputs.should_skip != 'true' }}
    timeout-minutes: 45
    needs: pre_job
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        rust_release: [latest-nightly, latest-stable]
        exclude:
          # For non-pull requests, event_name != 'pull_request' will be true, and 'nothing' is
          # truthy, so the entire && operator will resolve to 'nothing'. Then the || operator will
          # resolve to 'nothing' so we will exclude 'nothing'. https://stackoverflow.com/a/73822998
          - rust_release: ${{ (((github.event_name != 'pull_request' && github.event_name != 'push') || (github.event_name == 'pull_request' && (contains(github.event.pull_request.title, '[ci-full]') || contains(github.event.pull_request.body, '[ci-full]')))) && 'nothing') || 'latest-nightly' }}
          - os: ${{ (((github.event_name != 'pull_request' && github.event_name != 'push') || (github.event_name == 'pull_request' && (contains(github.event.pull_request.title, '[ci-full]') || contains(github.event.pull_request.body, '[ci-full]')))) && 'nothing') || 'windows-latest' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install rust channel and set it as default
        if: ${{ matrix.rust_release == 'latest-nightly' }}
        run: |
          rustup toolchain add nightly && \
          rustup default nightly

      - if: matrix.rust_release == 'latest-stable' && matrix.os == 'ubuntu-latest'
        uses: ./.github/actions/use-sccache

      - uses: ./.github/actions/install-nexttest
        with:
          os: ${{ matrix.os }}

      - name: Run cargo nextest on all targets
        run: cargo nextest run --no-fail-fast --features hydro_lang/deploy --all-targets

      - name: Run doctests
        # Not supported by nextest: https://github.com/nextest-rs/nextest/issues/16
        run: cargo test --no-fail-fast --features hydro_lang/deploy --doc

      - run: cargo clippy --all-targets -- -D warnings
      - run: cargo check --all-targets
      - run: cargo check --all-targets --no-default-features

      - run: cargo fmt --all -- --check

  test-wasm:
    name: Test Suite (WebAssembly)
    if: ${{ needs.pre_job.outputs.should_skip != 'true' }}
    timeout-minutes: 15
    needs: pre_job
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust_release: [latest-nightly, latest-stable]
        exclude:
          #   # For non-pull requests, event_name != 'pull_request' will be true, and 'nothing' is
          #   # truthy, so the entire && operator will resolve to 'nothing'. Then the || operator will
          #   # resolve to 'nothing' so we will exclude 'nothing'. https://stackoverflow.com/a/73822998
          - rust_release: ${{ (((github.event_name != 'pull_request' && github.event_name != 'push') || (github.event_name == 'pull_request' && (contains(github.event.pull_request.title, '[ci-full]') || contains(github.event.pull_request.body, '[ci-full]')))) && 'nothing') || 'latest-nightly' }}

    env:
      RUSTUP_TOOLCHAIN: ${{ matrix.rust_release == 'latest-nightly' && 'nightly' || '' }}

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install rust channel and set it as default
        if: ${{ matrix.rust_release == 'latest-nightly' }}
        run: |
          rustup toolchain add nightly && \
          rustup default nightly

      - name: Install wasm target
        run: rustup target add wasm32-unknown-unknown

      - name: Determine wasm-bindgen version
        id: wasm-bindgen-version
        run: echo "VERSION=$(cargo pkgid wasm-bindgen-shared | cut -d '@' -f2)" >> "$GITHUB_OUTPUT"

      - name: Install WebAssembly test runner
        run: cargo install wasm-bindgen-cli@${{ steps.wasm-bindgen-version.outputs.VERSION }}

      - name: Run cargo test
        env:
          CARGO_TARGET_WASM32_UNKNOWN_UNKNOWN_RUNNER: wasm-bindgen-test-runner
        run: cargo test -p dfir_rs --target wasm32-unknown-unknown --tests --no-fail-fast

      - run: cargo check -p dfir_rs --target wasm32-unknown-unknown
